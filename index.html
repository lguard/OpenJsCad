<!DOCTYPE html>

<html><head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <script src="lib/three.min.js"></script>
  <script src="lib/orbitcontrols.js"></script>
  <!-- fallback if no WebGL -->
  <script src="lib/projector.js"></script>
  <script src="lib/canvasrenderer.js"></script>
  <script src="lib/jquery-2.1.3.min.js"></script>
  <script src="src/csg.js"></script>
  <script src="src/threecsg.js"></script>
  <script src="src/openjscad.js"></script>
  <script src="src/formats.js"></script>

  <style>

body {
  font: 14px/20px 'Helvetica Neue Light', HelveticaNeue-Light, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  max-width: 820px;
  margin: 0 auto;
  padding: 10px;
}

pre, code, textarea {
  font: 12px/20px Monaco, monospace;
  border: 1px solid #CCC;
  border-radius: 3px;
  background: #F9F9F9;
  padding: 0 3px;
  color: #555;
}
pre, textarea {
  padding: 10px;
  width: 100%;
}
textarea {
  height: 200px;
}
textarea:focus {
  outline: none;
}

canvas { cursor: move; }

  </style>
<link rel="stylesheet" href="openjscad.css" type="text/css">

<script>

const shape_code_map = {
    C: "pizze",
    W: "windmill",
    S: "star",
    R: "cube",
    '-': "place_holder"
};

const red = [1,0.4,0.415];
const green = [0.42,1,0.4];
const blue = [0.4,0.65,1];
const cyan = [0.53,1,0.96];
const purple = [0.86,0.4,1];
const yellow = [0.98,0.96,0.16];
const uncolored = [0.7,0.7,0.7];
const white = [1,1,1];

const color_code_map = {
     r: "red",
     g: "green",
     b: "blue",
     y: "yellow",
     p: "purple",
     c: "cyan",
     u: "uncolored",
     w: "white",
     '-': "white"
};

const jscad_begin = `
function main(params) {
    const red = [1,0.4,0.415];
    const green = [0.42,1,0.4];
    const blue = [0.4,0.65,1];
    const cyan = [0.53,1,0.96];
    const purple = [0.86,0.4,1];
    const yellow = [0.98,0.96,0.16];
    const uncolored = [0.7,0.7,0.7];
    const white = [1,1,1];

    var place_holder = CSG.cube({
        center: [0, 0, 0],
        radius: [0.0000001, 0.0000001, 0.0000001]
    });

    var cube = CSG.cube({
        center: [1, 1, 0.2],
        radius: [1, 1, 0.2]
    });

    var windmill_pre = CSG.cube({
        center: [1, 0.5, 0.2],
        radius: [1, 0.5, 0.2]
    });
    var cylinder = CSG.cylinder({
      start: [0, 0, 0],
      end: [0, 0, 0.4],
      radius: 2,
      resolution: 30
    });

    var windill_arm = CSG.polyhedron({
       points:[ [0,1,0],[2,1,0],[2,2,0],
                [0,1,0.4],[2,1,0.4],[2,2,0.4],
              ],
       faces:[ [0,1,2],[4,3,5], [0,3,4], [1,0,4], [4,5,1], [2,1,5], [3,0,5], [5,0,2] ]
    });

    var star_base = cube.scale([0.5,0.5,1]);
    var star_arm = CSG.polyhedron({
       points:[ [0,1,0],[2,2,0],[1,0,0],
                [0,1,0.4],[2,2,0.4],[1,0,0.4],
              ],
       faces:[ [0,2,1],[3,4,5], [3,0,4], [0,1,4], [5,4,1], [1,2,5], [0,3,5], [0,5,2] ]
    });

    var windmill = windmill_pre.union(windill_arm);
    var pizze = cube.intersect(cylinder);
    var star = star_base.union(star_arm);
    var shapez = [];
`

const jscad_end = `
return place_holder.union(shapez);
}
`

function shape_generator_template(shape, shape_color, layer) {
    const shape_js = `
    shapez[${layer}-1] = place_holder.union([
        ${shape[0]}.setColor(${shape_color[0]}).rotateZ(180),
        ${shape[1]}.setColor(${shape_color[1]}).rotateZ(90),
        ${shape[2]}.setColor(${shape_color[2]}),
        ${shape[3]}.setColor(${shape_color[3]}).rotateZ(-90)
    ]).scale([Math.pow(0.7,${layer}),Math.pow(0.7,${layer}),1]).translate([0,0,0.4*(${layer}-1)])
    `
    return shape_js
}

function generate_shape() {
    const regex = /([CRWS-][rgbycuwp-])([CRWS-][rgbycuwp-])([CRWS-][rgbycuwp-])([CRWS-][rgbycuwp-])/gm;
    var url = new URL(window.location.href);
    var str = url.searchParams.get("shape");
    let m;
    let i = 1
    let jscad_complete = jscad_begin
    while ((m = regex.exec(str)) !== null) {
        // This is necessary to avoid infinite loops with zero-width matches
        if (m.index === regex.lastIndex) {
            regex.lastIndex++;
        }
        var shape = [
            shape_code_map[m[1].charAt(0)],
            shape_code_map[m[2].charAt(0)],
            shape_code_map[m[3].charAt(0)],
            shape_code_map[m[4].charAt(0)],
        ]
        var shape_color = [
            color_code_map[m[1].charAt(1)],
            color_code_map[m[2].charAt(1)],
            color_code_map[m[3].charAt(1)],
            color_code_map[m[4].charAt(1)],
        ]
        jscad_complete += shape_generator_template(shape, shape_color, i)
        i = i + 1
    }
    jscad_complete += jscad_end;
    document.getElementById("code").value = jscad_complete
}

function generate_shape_uri() {
    let str = document.getElementById("shape_code").value;
    if (str == "") {
        str = `CpWuRcSp:WwRuCp--:SuCcScSp:CrScSuSc`
    }
    str = "?shape=" + encodeURI(str)
    window.history.replaceState(null, null, str);
    generate_shape()
}

function enter_input() {
    if(event.keyCode == 13) {
        generate_shape_uri()
        updateSolid()
    }
}

var gProcessor=null;

// Show all exceptions to the user:
OpenJsCad.AlertUserOfUncaughtExceptions();

function onload()
{
    generate_shape_uri()
    gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"));
    updateSolid();
}

function updateSolid()
{
    gProcessor.setJsCad(document.getElementById('code').value);
}

</script>
<title>OpenJsCad</title>  
</head>
<body onload="onload()">
  <h1>Shapez 3d viewer</h1>
<div id="viewer"></div>
<input id="shape_code" placeholder="shape code" onchange="generate_shape_uri()" onkeydown="enter_input()">
  <h2>Playground</h2>
The jscad output can be edited bellow see original project <a href="https://joostn.github.io/OpenJsCad/">https://joostn.github.io/OpenJsCad/</a>
<br>- <a href="http://openjscad.azurewebsites.net/">http://openjscad.azurewebsites.net/</a><br>- <a href="https://github.com/jscad/OpenJSCAD.org">https://github.com/jscad/OpenJSCAD.org</a>
<br><br>
<textarea id="code">
</textarea><br>
<input type="submit" value="Update" onclick="updateSolid(); return false;">

</body>
</html>
